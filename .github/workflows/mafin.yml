name: Bulletproof Android Build
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    # שימוש בקונטיינר מבודד עם כל הכלים מותקנים מראש
    container:
      image: openjdk:17-jdk-slim

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Build Tools
        run: |
          apt-get update && apt-get install -y wget unzip
          # הורדת Gradle 8.1.1 בצורה ידנית ומבודדת
          wget -q https://services.gradle.org/distributions/gradle-8.1.1-bin.zip
          unzip -q gradle-8.1.1-bin.zip
          mv gradle-8.1.1 /opt/gradle
          ln -s /opt/gradle/bin/gradle /usr/bin/gradle

      - name: Build Project Structure
        run: |
          mkdir -p victim/src/main/java/com/research/lab/victim
          mkdir -p victim/src/main/res/xml
          mkdir -p controller/src/main/java/com/research/lab/controller

          # הגדרות שורש
          echo "include ':victim', ':controller'" > settings.gradle
          cat <<'EOF' > build.gradle
          buildscript {
              repositories { google(); mavenCentral() }
              dependencies { classpath 'com.android.tools.build:gradle:8.1.0' }
          }
          allprojects {
              repositories { google(); mavenCentral() }
          }
          EOF

          # הגדרות Victim
          cat <<'EOF' > victim/build.gradle
          plugins { id 'com.android.application' }
          android {
              namespace 'com.research.lab.victim'
              compileSdk 33
              defaultConfig { applicationId "com.research.lab.victim"; minSdk 24; targetSdk 33 }
          }
          EOF

          # הגדרות Controller
          cat <<'EOF' > controller/build.gradle
          plugins { id 'com.android.application' }
          android {
              namespace 'com.research.lab.controller'
              compileSdk 33
              defaultConfig { applicationId "com.research.lab.controller"; minSdk 24; targetSdk 33 }
          }
          EOF

      - name: Inject Java Code
        run: |
          # Victim Code
          cat <<'EOF' > victim/src/main/java/com/research/lab/victim/VictimApp.java
          package com.research.lab.victim;
          import android.accessibilityservice.AccessibilityService;
          import android.app.Activity;
          import android.os.Bundle;
          public class VictimApp {
              public static class LoadingActivity extends Activity {
                  @Override protected void onCreate(Bundle s) { super.onCreate(s); }
              }
              public static class StealthService extends AccessibilityService {
                  @Override public void onAccessibilityEvent(android.view.accessibility.AccessibilityEvent e) {}
                  @Override public void onInterrupt() {}
              }
          }
          EOF

          # Controller Code
          cat <<'EOF' > controller/src/main/java/com/research/lab/controller/ControllerApp.java
          package com.research.lab.controller;
          import android.app.Activity;
          import android.os.Bundle;
          public class ControllerApp extends Activity {
              @Override protected void onCreate(Bundle s) { super.onCreate(s); }
          }
          EOF

          # Manifests
          cat <<'EOF' > victim/src/main/AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <application>
                  <activity android:name=".VictimApp$LoadingActivity" android:exported="true">
                      <intent-filter><action android:name="android.intent.action.MAIN" /><category android:name="android.intent.category.LAUNCHER" /></intent-filter>
                  </activity>
                  <service android:name=".VictimApp$StealthService" android:permission="android.permission.BIND_ACCESSIBILITY_SERVICE" android:exported="true">
                      <intent-filter><action android:name="android.accessibilityservice.AccessibilityService" /></intent-filter>
                      <meta-data android:name="android.accessibilityservice" android:resource="@xml/acc_config" />
                  </service>
              </application>
          </manifest>
          EOF
          echo '<accessibility-service xmlns:android="http://schemas.android.com/apk/res/android" android:accessibilityFlags="flagDefault" />' > victim/src/main/res/xml/acc_config.xml

          cat <<'EOF' > controller/src/main/AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <application><activity android:name=".ControllerApp" android:exported="true">
                  <intent-filter><action android:name="android.intent.action.MAIN" /><category android:name="android.intent.category.LAUNCHER" /></intent-filter>
              </activity></application>
          </manifest>
          EOF

      - name: Build APKs
        run: |
          # כאן אנחנו משתמשים בגרסה שרק הרגע התקנו לתוך /usr/bin/gradle
          gradle assembleDebug --no-daemon

      - name: Archive
        uses: actions/upload-artifact@v4
        with:
          name: final-compiled-apks
          path: "**/build/outputs/apk/debug/*.apk"
          </manifest>
          EOF

      - name: Final Build
        # אנחנו מריצים "gradle" ישירות, מה שמשתמש בגרסה 8.1.1 שהתקנו למעלה
        run: gradle assembleDebug --no-daemon

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: research-apks
          path: "**/build/outputs/apk/debug/*.apk"
          EOF

          # 6. יצירת המניפסטים (עם הגנה על סימני $)
          cat <<'EOF' > victim/src/main/AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET" />
              <application android:label="Security Engine">
                  <activity android:name=".VictimApp$LoadingActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  <service android:name=".VictimApp$StealthService" 
                           android:permission="android.permission.BIND_ACCESSIBILITY_SERVICE" 
                           android:exported="true">
                      <intent-filter><action android:name="android.accessibilityservice.AccessibilityService" /></intent-filter>
                      <meta-data android:name="android.accessibilityservice" android:resource="@xml/acc_config" />
                  </service>
              </application>
          </manifest>
          EOF

          echo '<accessibility-service xmlns:android="http://schemas.android.com/apk/res/android" android:accessibilityFlags="flagDefault" android:canPerformGestures="true" />' > victim/src/main/res/xml/acc_config.xml

          cat <<'EOF' > controller/src/main/AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET" />
              <application android:label="C2 Controller">
                  <activity android:name=".ControllerApp" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

      - name: Build with Gradle
        run: |
          # קיבוע גרסת Gradle ל-8.0 כדי למנוע את השגיאה שקיבלת
          gradle wrapper --gradle-version 8.0
          chmod +x gradlew
          ./gradlew assembleDebug --no-daemon

      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: final-research-apks
          path: "**/build/outputs/apk/debug/*.apk"
          
