name: Bazel Android Build
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Bazel
        run: |
          sudo apt-get update && sudo apt-get install -y bazel-bootstrap
          # אנחנו משתמשים ב-Bazel כי הוא מתעלם לחלוטין מגרסאות Gradle של המערכת

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Create Structure and Bazel Files
        run: |
          mkdir -p src/main/java/com/research/lab
          
          # קובץ WORKSPACE - מגדיר את הפרויקט ללא Gradle
          cat <<'EOF' > WORKSPACE
          android_sdk_repository(name = "androidsdk")
          EOF

          # קובץ BUILD - מגדיר איך לבנות את ה-APK
          cat <<'EOF' > BUILD
          android_binary(
              name = "victim_app",
              manifest = "AndroidManifest.xml",
              deps = [":lib"],
          )
          android_library(
              name = "lib",
              srcs = ["src/main/java/com/research/lab/App.java"],
          )
          EOF

          # יצירת הקוד
          cat <<'EOF' > src/main/java/com/research/lab/App.java
          package com.research.lab;
          import android.app.Activity;
          import android.os.Bundle;
          public class App extends Activity {
              @Override protected void onCreate(Bundle s) { super.onCreate(s); }
          }
          EOF

          # יצירת המניפסט
          cat <<'EOF' > AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.research.lab">
              <application android:label="ResearchApp">
                  <activity android:name=".App" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

      - name: Build with Bazel
        run: |
          # הפקודה הזו בונה APK בלי לגעת ב-Gradle אפילו פעם אחת
          bazel build //:victim_app

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: bazel-apk
          path: bazel-bin/*.apk
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: research-apks
          path: "**/build/outputs/apk/debug/*.apk"
