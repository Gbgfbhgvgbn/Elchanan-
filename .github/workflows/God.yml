name: Fail-Safe Multi-Method Build
on: [push, workflow_dispatch]

jobs:
  build-everything:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- שלב ניקוי טוטאלי ---
      - name: Hard Reset Project
        run: |
          # מחיקת כל מה שלא שייך לסקריפט הקימפול
          find . -maxdepth 1 ! -name '.github' ! -name '.' -exec rm -rf {} +
          sudo rm -rf ~/.gradle /opt/hostedtoolcache/gradle
          echo "All caches and files purged."

      - name: Java & SDK Setup
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # --- שיטה 1: GRADLE מבודד (הנחת המוצא שלך) ---
      - name: METHOD 1 - ISOLATED GRADLE
        id: m1
        continue-on-error: true
        run: |
          echo "Starting Method 1..."
          curl -L https://services.gradle.org/distributions/gradle-8.1.1-bin.zip -o gradle.zip
          unzip -q gradle.zip
          mkdir -p app/src/main/java/com/research/lab
          echo "include ':app'" > settings.gradle
          echo "buildscript { repositories { google(); mavenCentral() }; dependencies { classpath 'com.android.tools.build:gradle:8.1.0' } }" > build.gradle
          echo "allprojects { repositories { google(); mavenCentral() } }" >> build.gradle
          # בניית קובץ האפליקציה
          cat <<'EOF' > app/build.gradle
          plugins { id 'com.android.application' }
          android { namespace 'com.research.lab'; compileSdk 33
              defaultConfig { applicationId "com.research.lab"; minSdk 24; targetSdk 33 } }
          EOF
          # הרצה ישירה מהתיקייה שהורדנו (בלי לגעת ב-gradle של המערכת)
          ./gradle-8.1.1/bin/gradle assembleDebug --no-daemon --no-build-cache
          cp app/build/outputs/apk/debug/*.apk final_app.apk

      # --- שיטה 2: MANUAL CLI (אם גראדל נכשל, זה בטוח יעבוד) ---
      - name: METHOD 2 - DIRECT CLI (AAPT2 + D8)
        if: steps.m1.outcome == 'failure'
        id: m2
        continue-on-error: true
        run: |
          echo "Method 1 failed. Starting Method 2 (No Gradle)..."
          sudo rm -rf ~/.gradle # ניקוי נוסף
          # הגדרת נתיבים ידנית
          SDK_TOOLS=$ANDROID_HOME/build-tools/33.0.0
          PLATFORM=$ANDROID_HOME/platforms/android-33/android.jar
          mkdir -p obj bin res/values src/com/research/lab
          # קוד ומניפסט
          echo 'package com.research.lab; public class Main extends android.app.Activity {}' > src/com/research/lab/Main.java
          echo '<manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.research.lab"><application><activity android:name=".Main" android:exported="true"><intent-filter><action android:name="android.intent.action.MAIN"/></intent-filter></activity></application></manifest>' > AndroidManifest.xml
          echo '<resources><string name="app_name">Res</string></resources>' > res/values/strings.xml
          # קימפול ידני
          $SDK_TOOLS/aapt2 compile res/values/strings.xml -o res.zip
          $SDK_TOOLS/aapt2 link --manifest AndroidManifest.xml -I $PLATFORM res.zip -o unsigned.apk
          javac -source 1.8 -target 1.8 -bootclasspath $PLATFORM src/com/research/lab/Main.java -d obj/
          $SDK_TOOLS/d8 obj/com/research/lab/*.class --lib $PLATFORM --output bin/
          cd bin && zip -u ../unsigned.apk classes.dex
          mv ../unsigned.apk ../final_app.apk

      # --- שיטה 3: DOCKER (בידוד קונטיינר) ---
      - name: METHOD 3 - DOCKER
        if: steps.m1.outcome == 'failure' && steps.m2.outcome == 'failure'
        id: m3
        continue-on-error: true
        run: |
          echo "Method 2 failed. Starting Method 3 (Docker)..."
          docker run --rm -v $(pwd):/src mingyuliutw/android-build-box:latest /bin/bash -c "cd /src && gradle assembleDebug"
          cp app/build/outputs/apk/debug/*.apk final_app.apk

      # --- בדיקת תוצאה סופית ---
      - name: Check Success
        run: |
          if [ -f "final_app.apk" ]; then
            echo "Successfully built the APK!"
          else
            echo "ALL METHODS FAILED. System is completely locked."
            exit 1
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: research-apk
          path: final_app.apk
          
