name: Forced Downgrade Build
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with: { java-version: '17', distribution: 'temurin' }

      - name: Kill System Gradle & Build
        run: |
          # 1. מחיקה אגרסיבית של המטמון שגורם להפעלת גרסה 9
          sudo rm -rf /usr/bin/gradle /usr/local/bin/gradle /opt/hostedtoolcache/gradle
          
          # 2. יצירת פרויקט אנדרואיד בסיסי
          mkdir -p app/src/main/java/com/research/lab
          echo "include ':app'" > settings.gradle
          echo "buildscript { repositories { google(); mavenCentral() }; dependencies { classpath 'com.android.tools.build:gradle:8.1.0' } }" > build.gradle
          echo "allprojects { repositories { google(); mavenCentral() } }" >> build.gradle
          
          # 3. הורדה והפעלה של גרסה 8.1.1 בלבד (נתיב ישיר)
          curl -L https://services.gradle.org/distributions/gradle-8.1.1-bin.zip -o gradle.zip
          unzip -q gradle.zip
          ./gradle-8.1.1/bin/gradle assembleDebug --no-daemon
        id: m6
        run: |
          cat <<'EOF' > Makefile
          build:
          	@echo "Last resort build with Make"
          	# פקודת קימפול שורתית אחרונה
          EOF
          make build

      # --- בדיקת הצלחה סופית ---
      - name: Final Result Check
        run: |
          if [ -f "final_app.apk" ]; then
            echo "Build successful!"
          else
            echo "All 6 methods failed."
            exit 1
          fi

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: final-stable-apk
          path: final_app.apk
